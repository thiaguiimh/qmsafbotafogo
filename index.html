<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Quadro Móvel - Botafogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa; /* Um branco levemente acinzentado para o fundo geral */
        }
        .font_inter { 
            font-family: 'Inter', sans-serif;
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #e9ecef; 
        }
        ::-webkit-scrollbar-thumb {
            background: #adb5bd; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6c757d; 
        }
        .loader {
            border: 3px solid #dee2e6; 
            border-top: 3px solid #007bff; /* Um azul primário para o loader */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
        }
        /* Pequeno loader para botões */
        .loader_small_blue {
            border: 2px solid #cce5ff; /* Azul claro para contraste com botão azul */
            border-top: 2px solid #ffffff; /* Branco */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
         .loader_small_gray {
            border: 2px solid #e9ecef; 
            border-top: 2px solid #6c757d; 
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select, input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none; 
        }
         select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236c757d'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem; 
        }
        textarea {
            resize: vertical; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="min-h-screen font_inter flex flex-col">
        <header id="app-header" class="bg-white shadow-sm border-b border-gray-200 p-4 hidden sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://placehold.co/40x40/000000/FFFFFF?text=BFR&font=inter" alt="Logo Botafogo" class="h-8 w-8 rounded-md">
                    <h1 class="text-xl font-semibold text-gray-800">
                        Portal <span class="text-blue-600">Quadro Móvel</span>
                    </h1>
                </div>
                <div id="user-info-header" class="flex items-center space-x-4">
                    </div>
            </div>
        </header>

        <main id="app-content" class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">
            <div id="initial-loading" class="flex flex-col items-center justify-center h-full p-8">
                <div class="loader mb-3"></div>
                <p class="text-gray-600">Inicializando aplicação...</p>
            </div>
        </main>

        <footer id="app-footer" class="text-center p-5 border-t border-gray-200 text-gray-500 text-xs hidden">
            </footer>

        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4 hidden animate-fadeIn">
            <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
                </div>
        </div>

        <div id="notification-container" class="fixed top-6 right-6 z-[100] space-y-3 w-full max-w-sm sm:max-w-md">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            Timestamp,
            deleteDoc,
            updateDoc,
            onSnapshot,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfigFromUser = {
            apiKey: "AIzaSyDkRi6GWPiVawTe607frndhUbfB77yfVOw",
            authDomain: "qmsafbotafogo.firebaseapp.com",
            databaseURL: "https://qmsafbotafogo-default-rtdb.firebaseio.com",
            projectId: "qmsafbotafogo",
            storageBucket: "qmsafbotafogo.firebasestorage.app",
            messagingSenderId: "447753167474",
            appId: "1:447753167474:web:7706e7a5c78b4127a058eb"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
        
        const currentAppId = firebaseConfig.projectId || 'default-app-id';
        if (typeof __app_id !== 'undefined' && __app_id !== firebaseConfig.projectId) {
            console.warn(`Variável __app_id ('${__app_id}') detectada e diferente do projectId ('${firebaseConfig.projectId}'). Usando firebaseConfig.projectId para caminhos do Firestore para consistência com a configuração manual de dados que utiliza o projectId.`);
        }


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appHeader = document.getElementById('app-header');
        const appContent = document.getElementById('app-content');
        const appFooter = document.getElementById('app-footer');
        const userInfoHeader = document.getElementById('user-info-header');
        const initialLoadingDiv = document.getElementById('initial-loading');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const notificationContainer = document.getElementById('notification-container');

        let currentUser = null;
        let userProfile = null;
        let currentView = 'login';
        let globalData = {
            events: [], categories: [], sectors: [], employees: [], records: [], allUsers: []
        };
        let unsubscribers = [];

        const showElement = (el) => el.classList.remove('hidden');
        const hideElement = (el) => el.classList.add('hidden');

        function showNotification(message, type = 'info', duration = 4000) {
            const id = `notif-${Date.now()}`;
            let bgColor, textColor, iconColor, iconSvg;

            switch (type) {
                case 'error':
                    bgColor = 'bg-red-50'; textColor = 'text-red-700'; iconColor = 'text-red-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12zm-1-5a1 1 0 102 0v-2a1 1 0 10-2 0v2zm0 3a1 1 0 102 0 1 1 0 10-2 0z" clip-rule="evenodd" /></svg>`;
                    break;
                case 'success':
                    bgColor = 'bg-green-50'; textColor = 'text-green-700'; iconColor = 'text-green-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.707-4.293a1 1 0 00-1.414-1.414l-2-2a1 1 0 00-1.414 1.414L6.586 13H5a1 1 0 000 2h1.586l1.707 1.707a1 1 0 001.414-1.414l-2-2 1.293-1.293zM14.5 11a1 1 0 01-1-1V7a1 1 0 112 0v3a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>`;
                    break;
                default: // info
                    bgColor = 'bg-blue-50'; textColor = 'text-blue-700'; iconColor = 'text-blue-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12zm-1-5a1 1 0 102 0V8a1 1 0 10-2 0v3zm0 3a1 1 0 102 0 1 1 0 10-2 0z" clip-rule="evenodd" /></svg>`;
            }
            
            const notificationDiv = document.createElement('div');
            notificationDiv.id = id;
            notificationDiv.className = `animate-fadeIn p-4 rounded-lg shadow-lg ${bgColor} ${textColor} flex items-start space-x-3 border border-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}-200`;
            notificationDiv.innerHTML = `
                <div class="${iconColor} mt-0.5">${iconSvg}</div>
                <div class="flex-1">
                    <p class="font-medium">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                    <p class="text-sm">${message}</p>
                </div>
                <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('${id}').remove()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                </button>
            `;
            notificationContainer.appendChild(notificationDiv);

            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, duration);
        }
        
        function openModal(title, contentHtml, onConfirmAsync = null, confirmText = 'Confirmar', onCancel = null, cancelText = 'Cancelar') {
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="text-gray-600 text-sm">${contentHtml}</div>
                <div id="modal-actions" class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    ${onCancel ? `<button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">${cancelText}</button>` : ''}
                    ${onConfirmAsync ? `<button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 min-w-[120px] text-center">${confirmText}</button>` : ''}
                </div>
            `;
            showElement(modalContainer);
            document.getElementById('modal-close-btn').onclick = closeModal;
            
            const cancelBtn = document.getElementById('modal-cancel-btn');
            if (cancelBtn && typeof onCancel === 'function') {
                cancelBtn.onclick = () => { closeModal(); onCancel(); };
            }
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            if (confirmBtn && typeof onConfirmAsync === 'function') {
                confirmBtn.onclick = async () => {
                    const originalButtonText = confirmBtn.innerHTML;
                    const cancelButton = document.getElementById('modal-cancel-btn');
                    
                    confirmBtn.disabled = true;
                    if(cancelButton) cancelButton.disabled = true;
                    confirmBtn.innerHTML = `<span class="flex items-center justify-center"><span class="loader_small_blue mr-2"></span>Processando...</span>`;

                    try {
                        await onConfirmAsync(); 
                    } catch (e) {
                        console.error("Error during modal confirm operation (caught in openModal):", e);
                    } finally {
                        closeModal(); 
                    }
                };
            }
        }

        function closeModal() {
            hideElement(modalContainer);
            modalContent.innerHTML = ''; 
        }

        function confirmAction(title, message, onConfirmAsync) { 
            openModal(title, `<p>${message}</p>`, onConfirmAsync, 'Confirmar', () => {}, 'Cancelar');
        }


        onAuthStateChanged(auth, async (firebaseUser) => {
            hideElement(initialLoadingDiv); 
            currentUser = firebaseUser;
            if (firebaseUser) {
                try {
                    console.log(`[onAuthStateChanged] Tentando buscar perfil. UID: ${firebaseUser.uid}, currentAppId: ${currentAppId}`);
                    const userDocRef = doc(db, 'artifacts', currentAppId, 'users_profile', firebaseUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        userProfile = { id: userDocSnap.id, ...userDocSnap.data() };
                        console.log("[onAuthStateChanged] Perfil do usuário encontrado:", userProfile); 
                        updateHeaderUI();
                        showElement(appHeader);
                        showElement(appFooter);
                        if (userProfile.isAdmin) currentView = 'adminDashboard';
                        else if (userProfile.isManager) currentView = 'managerDashboard';
                        else {
                            showNotification("Usuário não possui perfil de gestor ou admin.", "error");
                            currentView = 'login'; 
                            await handleLogout(); 
                        }
                        loadAllData(); 
                    } else {
                        showNotification("Perfil do usuário não encontrado. Contacte o administrador.", "error");
                        console.warn(`[onAuthStateChanged] Perfil não encontrado para UID: ${firebaseUser.uid} no caminho artifacts/${currentAppId}/users_profile/`);
                        await handleLogout(); 
                    }
                } catch (error) {
                    console.error("[onAuthStateChanged] Erro ao buscar perfil:", error); 
                    showNotification("Erro ao carregar perfil. Tente novamente.", "error");
                    await handleLogout();
                }
            } else {
                userProfile = null;
                hideElement(appHeader);
                hideElement(appFooter);
                currentView = 'login';
                clearAllDataAndUnsubscribe();
            }
            renderApp();
        });
        
        async function performInitialSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Nenhum token de autenticação inicial. Aguardando login do usuário.");
                }
            } catch (error) {
                console.error("Erro no signInWithCustomToken:", error);
                showNotification("Falha na autenticação inicial.", "error");
            }
        }

        async function handleLogin(email, password) {
            appContent.innerHTML = `<div class="flex flex-col justify-center items-center h-64"><div class="loader"></div><p class="ml-3 text-gray-600 mt-3">Entrando...</p></div>`;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification("Login bem-sucedido!", "success");
            } catch (error) {
                console.error("Erro no login:", error);
                showNotification(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential'
                    ? "Email ou senha inválidos."
                    : `Erro ao fazer login: ${error.message} (código: ${error.code})`, "error"); 
                renderApp(); 
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showNotification("Logout realizado com sucesso!", "success");
            } catch (error) {
                console.error("Erro no logout:", error);
                showNotification("Erro ao fazer logout.", "error");
            }
        }

        function updateHeaderUI() {
            if (userProfile) {
                userInfoHeader.innerHTML = `
                    <span class="text-sm text-gray-600 hidden sm:block">
                        Olá, <span class="font-medium text-gray-800">${userProfile.name}</span> 
                        <span class="text-gray-400">(${userProfile.isAdmin ? 'Admin' : userProfile.isManager ? `Gestor - ${userProfile.sector}` : 'Usuário'})</span>
                    </span>
                    <button id="logout-btn" class="text-sm font-medium text-blue-600 hover:text-blue-700 py-2 px-3 rounded-lg hover:bg-blue-50 transition-colors duration-150 flex items-center space-x-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Sair</span>
                    </button>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                appFooter.innerHTML = `© ${new Date().getFullYear()} SAF Botafogo. Todos os direitos reservados. <span class="text-gray-400">UID: ${currentUser?.uid}</span>`;
            } else {
                userInfoHeader.innerHTML = '';
            }
        }
        
        function getCollectionRef(collectionName, isPublic = true) {
            if (isPublic) {
                return collection(db, 'artifacts', currentAppId, 'public', 'data', collectionName);
            }
            return collection(db, 'artifacts', currentAppId, collectionName);
        }

        async function fetchDataWithListener(collectionName, dataKey, queryConstraints = [], isPublic = true, targetCollectionRef = null) {
            if (!userProfile) return; 

            const collRef = targetCollectionRef || getCollectionRef(collectionName, isPublic);
            let qConstraints = [...queryConstraints]; // Copia para não modificar o array original

            // Filtro específico para gestores
            if (dataKey === 'records' && userProfile.isManager && !userProfile.isAdmin) {
                qConstraints.push(where("sector", "==", userProfile.sector));
            }
            // FILTRO ADICIONADO PARA FUNCIONÁRIOS
            if (dataKey === 'employees' && userProfile.isManager && !userProfile.isAdmin) {
                qConstraints.push(where("sector", "==", userProfile.sector));
            }
            
            let q = query(collRef, ...qConstraints);
            
            console.log(`[fetchDataWithListener] Configurando listener para ${dataKey} em ${collRef.path} com constraints:`, qConstraints);
            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`[fetchDataWithListener] Dados recebidos para ${dataKey}: ${snapshot.docs.length} itens.`);
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (dataKey === 'records' || dataKey === 'events') {
                    items.sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
                }
                globalData[dataKey] = items;
                if (document.getElementById('app-content')) { 
                    renderApp(); 
                }
            }, (error) => {
                console.error(`[fetchDataWithListener] Erro ao carregar ${collectionName} (dataKey: ${dataKey}). Path: ${collRef.path}. Query Constraints:`, qConstraints, "Objeto do Erro Firebase:", error);
                showNotification(`Falha ao carregar ${collectionDisplayName(collectionName).plural}.`, "error");
            });
            unsubscribers.push(unsubscribe);
        }

        function loadAllData() {
            clearAllDataAndUnsubscribe(); 
            if (userProfile) {
                fetchDataWithListener('events', 'events'); // Coleção pública
                fetchDataWithListener('categories', 'categories'); // Coleção pública
                fetchDataWithListener('sectors', 'sectors'); // Coleção pública
                
                // Funcionários - filtrado por setor para gestores
                fetchDataWithListener('employees', 'employees'); 
                
                // Registros - filtrado por setor para gestores
                fetchDataWithListener('records', 'records', [], false, getCollectionRef('records', false));

                if (userProfile.isAdmin) {
                    // Todos os usuários - apenas para admin
                    fetchDataWithListener('users_profile', 'allUsers', [], false, getCollectionRef('users_profile', false));
                }
            }
        }
        
        function clearAllDataAndUnsubscribe() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            globalData = { events: [], categories: [], sectors: [], employees: [], records: [], allUsers: [] };
        }

        async function addRecordToFirestore(recordData) {
            if (!userProfile) {
                showNotification("Perfil do usuário não carregado. Não é possível salvar o registro.", "error");
                return Promise.reject(new Error("Perfil não carregado"));
            }
            if (!userProfile.isManager) {
                showNotification("Apenas gestores podem adicionar registros.", "error");
                return Promise.reject(new Error("Acesso negado, não é gestor"));
            }
            if (!userProfile.sector || userProfile.sector.trim() === "") { 
                showNotification("Setor do gestor não definido no perfil. Não é possível salvar o registro. Contacte o administrador.", "error");
                console.error("[addRecordToFirestore] Tentativa de salvar registro, mas userProfile.sector é indefinido ou vazio:", userProfile);
                return Promise.reject(new Error("Setor do gestor não definido"));
            }

            try {
                const recordsCollectionRef = getCollectionRef('records', false);
                const dataToSave = {
                    ...recordData,
                    managerId: currentUser.uid,
                    managerName: userProfile.name,
                    sector: userProfile.sector, 
                    createdAt: Timestamp.now()
                };
                console.log("[addRecordToFirestore] Dados para salvar:", dataToSave);
                await addDoc(recordsCollectionRef, dataToSave);
                showNotification("Registro adicionado com sucesso!", "success");
                currentView = userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard';
            } catch (error) {
                console.error("[addRecordToFirestore] Erro ao adicionar registro:", error);
                showNotification("Falha ao adicionar registro. Verifique o console para detalhes.", "error");
                throw error; 
            }
        }
        
        async function addItemToFirestore(collectionNameKey, data, isPublic = true) {
            if (!userProfile) { 
                showNotification("Perfil de usuário não carregado. Tente recarregar a página.", "error");
                return Promise.reject(new Error("Perfil não carregado"));
            }
            if (!userProfile.isAdmin) { 
                showNotification("Acesso negado. Apenas administradores podem adicionar itens.", "error");
                return Promise.reject(new Error("Acesso negado"));
            }
            if (!currentUser || !currentUser.uid) {
                showNotification("Informação do usuário atual (UID) não disponível.", "error");
                return Promise.reject(new Error("UID do usuário não disponível"));
            }

            const dataToWrite = { ...data, createdAt: Timestamp.now(), createdBy: currentUser.uid };
            
            console.log(`[addItemToFirestore] Tentando adicionar em '${collectionNameKey}'.`);
            console.log(`[addItemToFirestore] Path: artifacts/${currentAppId}/${isPublic ? 'public/data/' : ''}${collectionNameKey}`);
            console.log("[addItemToFirestore] Dados para escrever:", JSON.stringify(dataToWrite));
            console.log(`[addItemToFirestore] UID do Usuário: ${currentUser.uid}, isAdmin (cliente): ${userProfile.isAdmin}`);

            try {
                const collRef = getCollectionRef(collectionNameKey, isPublic);
                await addDoc(collRef, dataToWrite);
                showNotification(`${collectionDisplayName(collectionNameKey).singular} adicionado com sucesso!`, "success");
            } catch (e) {
                showNotification(`Erro ao adicionar ${collectionDisplayName(collectionNameKey).singular}. Detalhes no console.`, "error");
                console.error(`[addItemToFirestore] Falha ao adicionar em '${collectionNameKey}'. Path: artifacts/${currentAppId}/${isPublic ? 'public/data/' : ''}${collectionNameKey}. UID: ${currentUser.uid}. Dados:`, dataToWrite, "Objeto do Erro:", e);
                throw e; 
            }
        }

        async function updateItemInFirestore(collectionNameKey, id, data, isPublic = true, targetCollectionRef = null) {
            if (!userProfile) { 
                showNotification("Perfil de usuário não carregado.", "error");
                return Promise.reject(new Error("Perfil não carregado"));
            }
            if (!userProfile.isAdmin) { 
                showNotification("Acesso negado.", "error");
                return Promise.reject(new Error("Acesso negado"));
            }
             if (!currentUser || !currentUser.uid) {
                showNotification("Informação do usuário atual (UID) não disponível.", "error");
                return Promise.reject(new Error("UID do usuário não disponível"));
            }
            const dataToWrite = { ...data, updatedAt: Timestamp.now(), updatedBy: currentUser.uid };
             console.log(`Tentando atualizar item '${id}' em '${collectionNameKey}'. Path: artifacts/${currentAppId}/${isPublic ? 'public/data/' : ''}${collectionNameKey}`);
            console.log("Dados para atualizar:", dataToWrite);

            try {
                const itemDocRef = doc(targetCollectionRef || getCollectionRef(collectionNameKey, isPublic), id);
                await updateDoc(itemDocRef, dataToWrite);
                showNotification(`${collectionDisplayName(collectionNameKey).singular} atualizado com sucesso!`, "success");
            } catch (e) { 
                showNotification(`Erro ao atualizar ${collectionDisplayName(collectionNameKey).singular}. Detalhes no console.`, "error"); 
                console.error(`Falha ao atualizar item '${id}' em '${collectionNameKey}'. Dados:`, dataToWrite, "Objeto do Erro:", e);
                throw e; 
            }
        }
        
        async function deleteItemFromFirestore(collectionNameKey, id, isPublic = true, targetCollectionRef = null) {
            if (!userProfile?.isAdmin) {
                 showNotification("Acesso negado.", "error");
                 return; 
            }
            
            confirmAction(
                `Confirmar Exclusão`, 
                `Tem certeza que deseja excluir este item de ${collectionDisplayName(collectionNameKey).plural}? Esta ação não pode ser desfeita.`,
                async () => { 
                    try {
                        console.log(`Tentando excluir item '${id}' de '${collectionNameKey}'. Path: artifacts/${currentAppId}/${isPublic ? 'public/data/' : ''}${collectionNameKey}`);
                        await deleteDoc(doc(targetCollectionRef || getCollectionRef(collectionNameKey, isPublic), id));
                        showNotification(`${collectionDisplayName(collectionNameKey).singular} excluído com sucesso!`, "success");
                    } catch (e) { 
                        showNotification(`Erro ao excluir ${collectionDisplayName(collectionNameKey).singular}. Detalhes no console.`, "error"); 
                        console.error(`Falha ao excluir item '${id}' de '${collectionNameKey}'. Objeto do Erro:`, e);
                    }
                }
            );
        }
        
        function collectionDisplayName(key) {
            const names = {
                events: { singular: "Evento", plural: "Eventos" },
                categories: { singular: "Categoria", plural: "Categorias" },
                sectors: { singular: "Setor", plural: "Setores" },
                employees: { singular: "Funcionário", plural: "Funcionários" },
                users_profile: { singular: "Usuário", plural: "Usuários" }
            };
            return names[key] || { singular: key.slice(0,-1) || key, plural: key };
        }


        function renderApp() {
            if (!currentUser && currentView !== 'login') { 
                 currentView = 'login';
            }
            
            if (!appContent) {
                console.error("Elemento #app-content não encontrado no DOM.");
                return;
            }
            appContent.innerHTML = ''; 
            hideElement(initialLoadingDiv); 

            switch (currentView) {
                case 'login': renderLoginPage(); break;
                case 'managerDashboard': renderManagerDashboard(); break;
                case 'newRecord': renderNewRecordForm(); break;
                case 'history': renderRecordHistory(); break;
                case 'adminDashboard': renderAdminDashboard(); break;
                case 'adminManageEvents':
                    renderAdminManageGenericPage('events', globalData.events, 
                        [{ name: 'name', label: 'Nome do Evento', type: 'text' }, { name: 'date', label: 'Data', type: 'date' }],
                        (data) => addItemToFirestore('events', data),
                        (id, data) => updateItemInFirestore('events', id, data),
                        (id) => deleteItemFromFirestore('events', id)
                    ); break;
                case 'adminManageCategories':
                    renderAdminManageGenericPage('categories', globalData.categories,
                        [{ name: 'name', label: 'Nome da Categoria (A, B, C, D)', type: 'text' }, { name: 'description', label: 'Descrição', type: 'text' }],
                        (data) => addItemToFirestore('categories', data),
                        (id, data) => updateItemInFirestore('categories', id, data),
                        (id) => deleteItemFromFirestore('categories', id)
                    ); break;
                case 'adminManageSectors':
                    renderAdminManageGenericPage('sectors', globalData.sectors,
                        [{ name: 'name', label: 'Nome do Setor', type: 'text' }],
                        (data) => addItemToFirestore('sectors', data),
                        (id, data) => updateItemInFirestore('sectors', id, data),
                        (id) => deleteItemFromFirestore('sectors', id)
                    ); break;
                case 'adminManageEmployees':
                    renderAdminManageGenericPage('employees', globalData.employees,
                        [
                            { name: 'name', label: 'Nome do Funcionário', type: 'text' },
                            { name: 'registration', label: 'Matrícula', type: 'text' },
                            { name: 'sector', label: 'Setor', type: 'select', options: globalData.sectors.map(s => ({ value: s.name, label: s.name })) }
                        ],
                        (data) => addItemToFirestore('employees', data),
                        (id, data) => updateItemInFirestore('employees', id, data),
                        (id) => deleteItemFromFirestore('employees', id)
                    ); break;
                case 'adminManageUsers': renderAdminManageUsersPage(); break;
                default: renderLoginPage();
            }
        }

        function renderLoginPage() {
            appContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-120px)] p-4 animate-fadeIn">
                    <div class="w-full max-w-sm bg-white shadow-xl rounded-xl p-8 border border-gray-200">
                        <div class="flex flex-col items-center mb-6">
                            <img src="https://placehold.co/80x80/000000/FFFFFF?text=BFR&font=inter" alt="Logo Botafogo" class="h-16 w-16 rounded-lg mb-5">
                            <h2 class="text-2xl font-semibold text-gray-800 text-center">Portal Quadro Móvel</h2>
                            <p class="text-gray-500 mt-1 text-sm text-center">Acesso para gestores e administradores.</p>
                        </div>
                        <form id="login-form" class="space-y-5">
                            <div>
                                <label for="email" class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                                <input id="email" type="email" required class="w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-400 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="seu.email@safbfr.com.br">
                            </div>
                            <div>
                                <label for="password" class="block text-xs font-medium text-gray-600 mb-1">Senha</label>
                                <input id="password" type="password" required class="w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-400 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="••••••••">
                            </div>
                            <button type="submit" class="w-full flex items-center justify-center text-sm bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-150 ease-in-out shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                                Entrar
                            </button>
                        </form>
                    </div>
                    <footer class="text-center p-6 mt-8 text-gray-500 text-xs">
                        © ${new Date().getFullYear()} SAF Botafogo. Todos os direitos reservados.
                    </footer>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                handleLogin(email, password);
            });
        }

        function renderManagerDashboard() {
            appContent.innerHTML = `
                <div class="animate-fadeIn bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-1">Bem-vindo, Gestor <span class="text-blue-600">${userProfile.name}</span>!</h2>
                    <p class="text-gray-500 mb-6 text-sm">Setor: <span class="font-medium text-gray-700">${userProfile.sector}</span>. Utilize as opções abaixo.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-8">
                        <button id="btn-new-record" class="flex flex-col items-center justify-center text-center p-6 bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium rounded-lg transition-all duration-150 ease-in-out border border-gray-200 hover:border-gray-300 shadow-sm hover:shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 text-blue-600"><path d="M12 5v14M5 12h14"></path></svg>
                            Incluir Novo Registro
                        </button>
                        <button id="btn-history" class="flex flex-col items-center justify-center text-center p-6 bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium rounded-lg transition-all duration-150 ease-in-out border border-gray-200 hover:border-gray-300 shadow-sm hover:shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 text-blue-600"><path d="M1 4v6h6M23 20v-6h-6"></path><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
                            Histórico de Registros
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('btn-new-record').addEventListener('click', () => { currentView = 'newRecord'; renderApp(); });
            document.getElementById('btn-history').addEventListener('click', () => { currentView = 'history'; renderApp(); });
        }
        
        function renderNewRecordForm() {
            const eventsOptions = globalData.events.sort((a,b) => new Date(b.date) - new Date(a.date)).map(event => `<option value="${event.id}">${event.name} (${new Date(event.date + 'T00:00:00').toLocaleDateString()})</option>`).join('');
            const categoriesOptions = globalData.categories.map(cat => `<option value="${cat.id}">${cat.name} - ${cat.description}</option>`).join('');
            // Employees are now filtered in globalData.employees if user is a manager
            const employeesOptions = globalData.employees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.registration}) - ${emp.sector}</option>`).join('');
            const inputBaseClass = "w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-800 placeholder-gray-400 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors";

            appContent.innerHTML = `
                <div class="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 animate-fadeIn">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Incluir Novo Registro de Quadro Móvel</h2>
                    <form id="new-record-form" class="space-y-5">
                        <div>
                            <label for="event" class="block text-xs font-medium text-gray-600 mb-1">Evento:</label>
                            <select id="event" required class="${inputBaseClass}">${eventsOptions ? `<option value="">Selecione o Evento</option>${eventsOptions}` : `<option value="">Nenhum evento cadastrado</option>`}</select>
                        </div>
                        <div>
                            <label for="category" class="block text-xs font-medium text-gray-600 mb-1">Classificação (Quadro Móvel):</label>
                            <select id="category" required class="${inputBaseClass}">${categoriesOptions ? `<option value="">Selecione a Classificação</option>${categoriesOptions}` : `<option value="">Nenhuma categoria cadastrada</option>`}</select>
                        </div>
                        <div>
                            <label for="employee" class="block text-xs font-medium text-gray-600 mb-1">Funcionário:</label>
                            <select id="employee" required class="${inputBaseClass}">${employeesOptions ? `<option value="">Selecione o Funcionário</option>${employeesOptions}` : `<option value="">Nenhum funcionário disponível para seu setor</option>`}</select>
                        </div>
                        <div>
                            <label for="notes" class="block text-xs font-medium text-gray-600 mb-1">Observações (Opcional):</label>
                            <textarea id="notes" class="${inputBaseClass} h-24" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                            <button type="button" id="cancel-new-record" class="w-full sm:w-auto px-4 py-2.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">Cancelar</button>
                            <button type="submit" class="w-full sm:w-auto px-4 py-2.5 text-sm bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-lg transition-colors duration-150 ease-in-out shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1.5"><path d="M12 5v14M5 12h14"></path></svg>
                                Salvar Registro
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('cancel-new-record').addEventListener('click', () => {
                currentView = userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard';
                renderApp();
            });
            document.getElementById('new-record-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonContent = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="flex items-center justify-center"><span class="loader_small_blue mr-2"></span>Salvando...</span>`;

                const eventId = document.getElementById('event').value;
                const categoryId = document.getElementById('category').value;
                const employeeId = document.getElementById('employee').value;
                const notes = document.getElementById('notes').value;

                if (!eventId || !categoryId || !employeeId) {
                    showNotification("Evento, Categoria e Funcionário são obrigatórios.", "error");
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                    return;
                }
                try {
                    await addRecordToFirestore({
                        eventId, eventName: globalData.events.find(ev => ev.id === eventId)?.name,
                        categoryId, categoryName: globalData.categories.find(cat => cat.id === categoryId)?.name,
                        employeeId, employeeName: globalData.employees.find(emp => emp.id === employeeId)?.name,
                        notes
                    });
                } catch (error) {
                    console.error("Falha ao submeter formulário de novo registro:", error);
                } finally {
                     if (currentView === 'newRecord') { 
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonContent;
                    }
                }
            });
        }

        function renderRecordHistory() {
            let recordsToDisplay = globalData.records;
            // A filtragem de records para gestores já é feita em fetchDataWithListener
            // if (userProfile.isManager && !userProfile.isAdmin) {
            //     recordsToDisplay = globalData.records.filter(r => r.sector === userProfile.sector);
            // }
            
            const tableRows = recordsToDisplay.map(record => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-5 py-3.5 text-xs text-gray-600 whitespace-nowrap">${record.createdAt?.toDate?.().toLocaleString('pt-BR', {dateStyle:'short', timeStyle:'short'}) || 'N/A'}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-700 font-medium whitespace-nowrap">${record.eventName || 'N/A'}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-600 whitespace-nowrap">${record.categoryName || 'N/A'}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-600 whitespace-nowrap">${record.employeeName || 'N/A'}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-600 whitespace-nowrap">${record.sector}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-600 whitespace-nowrap">${record.managerName}</td>
                    <td class="px-5 py-3.5 text-xs text-gray-500 max-w-xs truncate" title="${record.notes || ''}">${record.notes || '-'}</td>
                </tr>
            `).join('');

            appContent.innerHTML = `
                <div class="animate-fadeIn bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">Histórico de Registros</h2>
                            ${userProfile.isManager && !userProfile.isAdmin ? `<p class="text-xs text-gray-500 mt-0.5">Setor: ${userProfile.sector}</p>` : ''}
                        </div>
                        <button id="btn-back-dashboard" class="mt-3 md:mt-0 px-4 py-2 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Voltar ao Dashboard
                        </button>
                    </div>
                    ${recordsToDisplay.length === 0 ? 
                        `<div class="text-center py-10"><p class="text-gray-500 text-sm">Nenhum registro encontrado.</p></div>` :
                        `<div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Evento</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Categoria</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Funcionário</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Setor</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Gestor</th>
                                        <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Obs.</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>`
                    }
                </div>
            `;
            document.getElementById('btn-back-dashboard').addEventListener('click', () => {
                currentView = userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard';
                renderApp();
            });
        }
        
        function renderAdminDashboard() {
            const adminButtonBaseClass = "flex flex-col items-center justify-center text-center p-5 bg-white hover:bg-gray-50 text-gray-700 rounded-xl transition-all duration-150 ease-in-out border border-gray-200 hover:border-gray-300 shadow-sm hover:shadow-lg";
            const iconBaseClass = "w-8 h-8 mb-2 text-blue-600"; 

            appContent.innerHTML = `
                <div class="animate-fadeIn">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 mb-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-1">Painel Administrativo</h2>
                        <p class="text-gray-500 text-sm">Bem-vindo, <span class="font-medium text-gray-700">${userProfile.name}</span>. Gerencie todos os aspectos do sistema.</p>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-base font-semibold text-gray-500 mb-3 px-1">Ações Rápidas de Gestor</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="admin-btn-new-record" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                <span class="text-xs font-medium">Incluir Novo Registro</span>
                            </button>
                            <button id="admin-btn-history" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 4v6h6M23 20v-6h-6"></path><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
                                <span class="text-xs font-medium">Ver Histórico Completo</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-gray-500 mb-3 px-1">Gerenciamento do Sistema</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button id="admin-manage-events" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                <span class="text-xs font-medium">Gerenciar Eventos</span></button>
                            <button id="admin-manage-categories" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                                <span class="text-xs font-medium">Gerenciar Categorias</span></button>
                            <button id="admin-manage-sectors" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                <span class="text-xs font-medium">Gerenciar Setores</span></button>
                            <button id="admin-manage-employees" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                <span class="text-xs font-medium">Gerenciar Funcionários</span></button>
                            <button id="admin-manage-users" class="${adminButtonBaseClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="${iconBaseClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                <span class="text-xs font-medium">Gerenciar Usuários</span></button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('admin-btn-new-record').onclick = () => { currentView = 'newRecord'; renderApp(); };
            document.getElementById('admin-btn-history').onclick = () => { currentView = 'history'; renderApp(); };
            document.getElementById('admin-manage-events').onclick = () => { currentView = 'adminManageEvents'; renderApp(); };
            document.getElementById('admin-manage-categories').onclick = () => { currentView = 'adminManageCategories'; renderApp(); };
            document.getElementById('admin-manage-sectors').onclick = () => { currentView = 'adminManageSectors'; renderApp(); };
            document.getElementById('admin-manage-employees').onclick = () => { currentView = 'adminManageEmployees'; renderApp(); };
            document.getElementById('admin-manage-users').onclick = () => { currentView = 'adminManageUsers'; renderApp(); };
        }

        function renderAdminManageGenericPage(collectionKey, items, fields, onAdd, onUpdate, onDelete) {
            const cdn = collectionDisplayName(collectionKey); 
            const inputBaseClass = "w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-gray-800 placeholder-gray-400 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors";

            const tableHeaders = fields.map(f => `<th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">${f.label}</th>`).join('');
            const tableRows = items.map(item => `
                <tr class="hover:bg-gray-50 transition-colors">
                    ${fields.map(field => `<td class="px-5 py-3 text-xs text-gray-700 whitespace-nowrap">${field.type === 'date' && item[field.name] ? new Date(item[field.name] + 'T00:00:00').toLocaleDateString('pt-BR') : (item[field.name] || '-')}</td>`).join('')}
                    <td class="px-5 py-3 text-xs text-gray-500 whitespace-nowrap">${item.createdAt?.toDate?.().toLocaleDateString('pt-BR') || '-'}</td>
                    <td class="px-5 py-3 text-xs font-medium space-x-2.5 whitespace-nowrap">
                        <button class="btn-edit-item text-blue-600 hover:text-blue-700 p-1 hover:bg-blue-50 rounded-md" data-id="${item.id}" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn-delete-item text-red-500 hover:text-red-600 p-1 hover:bg-red-50 rounded-md" data-id="${item.id}" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                </tr>
            `).join('');

            appContent.innerHTML = `
                <div class="animate-fadeIn bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Gerenciar ${cdn.plural}</h2>
                        <div class="mt-3 sm:mt-0 flex space-x-2">
                            <button id="btn-back-admin-dash" class="px-3 py-2 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">Voltar</button>
                            <button id="btn-add-new-item" class="px-3 py-2 text-xs font-medium bg-gray-800 hover:bg-gray-900 text-white rounded-lg transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="mr-1.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Adicionar Novo
                            </button>
                        </div>
                    </div>
                    ${items.length === 0 ?
                        `<div class="text-center py-10"><p class="text-gray-500 text-sm">Nenhum item em "${cdn.plural}" cadastrado.</p></div>` :
                        `<div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr>${tableHeaders}<th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Criado Em</th><th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Ações</th></tr></thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>`
                    }
                </div>
            `;
            
            const openItemModal = (itemToEdit = null) => {
                let formHtml = '';
                fields.forEach(field => {
                    const value = itemToEdit ? (itemToEdit[field.name] || '') : '';
                    const fieldId = `field-${field.name}`; 
                    if (field.type === 'select') {
                        const optionsHtml = field.options.map(opt => `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
                        formHtml += `<div class="mb-4"><label for="${fieldId}" class="block text-xs font-medium text-gray-600 mb-1">${field.label}:</label><select id="${fieldId}" name="${field.name}" class="${inputBaseClass}" required><option value="">Selecione</option>${optionsHtml}</select></div>`;
                    } else {
                        formHtml += `<div class="mb-4"><label for="${fieldId}" class="block text-xs font-medium text-gray-600 mb-1">${field.label}:</label><input type="${field.type || 'text'}" id="${fieldId}" name="${field.name}" value="${value}" class="${inputBaseClass}" required></div>`;
                    }
                });
                const modalTitle = itemToEdit ? `Editar ${cdn.singular}` : `Adicionar ${cdn.singular}`;
                
                const asyncOperation = async () => {
                    const formData = {};
                    const formElement = document.getElementById('item-form');
                    if (formElement && !formElement.checkValidity()) {
                         showNotification("Por favor, preencha todos os campos obrigatórios.", "error");
                         formElement.reportValidity(); 
                         return Promise.reject(new Error("Formulário inválido")); 
                    }

                    fields.forEach(field => {
                        const inputElement = document.getElementById(`field-${field.name}`);
                        if (inputElement) {
                             formData[field.name] = inputElement.value;
                        } else {
                            console.warn(`Elemento do formulário não encontrado para o campo: field-${field.name}`);
                        }
                    });

                    if (itemToEdit) {
                        await onUpdate(itemToEdit.id, formData);
                    } else {
                        await onAdd(formData);
                    }
                };

                openModal(modalTitle, 
                    `<form id="item-form" class="space-y-1">${formHtml.replace(/class="mb-4"(?![\s\S]*class="mb-4")/g, '')}</form>`, 
                    asyncOperation, 
                    itemToEdit ? 'Salvar Alterações' : 'Adicionar'
                );
            };

            document.getElementById('btn-add-new-item').addEventListener('click', () => openItemModal());
            document.getElementById('btn-back-admin-dash').addEventListener('click', () => { currentView = 'adminDashboard'; renderApp(); });
            document.querySelectorAll('.btn-edit-item').forEach(btn => btn.addEventListener('click', (e) => {
                const itemId = e.currentTarget.dataset.id;
                const item = items.find(i => i.id === itemId);
                if (item) openItemModal(item);
            }));
            document.querySelectorAll('.btn-delete-item').forEach(btn => btn.addEventListener('click', (e) => {
                const itemId = e.currentTarget.dataset.id;
                deleteItemFromFirestore(collectionKey, itemId); 
            }));
        }

        function renderAdminManageUsersPage() {
            const users = globalData.allUsers;
            const cdn = collectionDisplayName('users_profile');
            const sectorsOptionsHtml = globalData.sectors.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            const inputBaseClass = "w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-gray-800 placeholder-gray-400 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors";
            const checkboxClass = "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500";


            const tableRows = users.map(user => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-5 py-3 text-xs text-gray-700 font-medium whitespace-nowrap">${user.name || 'N/A'}</td>
                    <td class="px-5 py-3 text-xs text-gray-600 whitespace-nowrap">${user.email}</td>
                    <td class="px-5 py-3 text-xs text-gray-600 whitespace-nowrap">${user.sector || 'N/A'}</td>
                    <td class="px-5 py-3 text-xs text-gray-600 whitespace-nowrap">${user.isManager ? '<span class="px-2 py-0.5 inline-flex text-xxs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sim</span>' : '<span class="px-2 py-0.5 inline-flex text-xxs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Não</span>'}</td>
                    <td class="px-5 py-3 text-xs text-gray-600 whitespace-nowrap">${user.isAdmin ? '<span class="px-2 py-0.5 inline-flex text-xxs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Sim</span>' : '<span class="px-2 py-0.5 inline-flex text-xxs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Não</span>'}</td>
                    <td class="px-5 py-3 text-xs font-medium whitespace-nowrap">
                        <button class="btn-edit-user text-blue-600 hover:text-blue-700 p-1 hover:bg-blue-50 rounded-md" data-id="${user.id}" title="Editar Usuário">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                    </td>
                </tr>
            `).join('');

            appContent.innerHTML = `
                <div class="animate-fadeIn bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Gerenciar ${cdn.plural}</h2>
                        <button id="btn-back-admin-dash-users" class="px-3 py-2 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">Voltar</button>
                    </div>
                    ${users.length === 0 ?
                        `<div class="text-center py-10"><p class="text-gray-500 text-sm">Nenhum usuário encontrado.</p></div>` :
                        `<div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Setor</th>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Gestor?</th>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Admin?</th>
                                    <th class="px-5 py-2.5 text-left text-xxs font-semibold text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr></thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>`
                    }
                </div>
            `;

            const openUserModal = (userToEdit) => {
                const formHtml = `
                    <form id="user-form" class="space-y-4">
                        <div><label for="userNameModal" class="block text-xs font-medium text-gray-600 mb-1">Nome:</label>
                             <input type="text" id="userNameModal" value="${userToEdit.name || ''}" class="${inputBaseClass}" required></div>
                        <div><label class="block text-xs font-medium text-gray-600 mb-1">Email: (Não editável)</label>
                             <input type="email" value="${userToEdit.email}" class="${inputBaseClass} bg-gray-100 cursor-not-allowed" readonly></div>
                        <div><label for="userSectorModal" class="block text-xs font-medium text-gray-600 mb-1">Setor:</label>
                             <select id="userSectorModal" class="${inputBaseClass}">
                                <option value="" ${!userToEdit.sector ? 'selected': ''}>Nenhum</option>
                                ${sectorsOptionsHtml.replace(new RegExp(`value="${userToEdit.sector}"`), `value="${userToEdit.sector}" selected`)}
                             </select></div>
                        <div class="grid grid-cols-2 gap-4 pt-1">
                            <label class="flex items-center space-x-2 text-sm text-gray-700"><input type="checkbox" id="userIsManagerModal" ${userToEdit.isManager ? 'checked' : ''} class="${checkboxClass}"><span>É Gestor?</span></label>
                            <label class="flex items-center space-x-2 text-sm text-gray-700"><input type="checkbox" id="userIsAdminModal" ${userToEdit.isAdmin ? 'checked' : ''} class="${checkboxClass}"><span>É Admin?</span></label>
                        </div>
                    </form>`;
                
                const asyncUserUpdate = async () => {
                    const formElement = document.getElementById('user-form');
                     if (formElement && !formElement.checkValidity()) {
                         showNotification("Por favor, preencha todos os campos obrigatórios.", "error");
                         formElement.reportValidity();
                         return Promise.reject(new Error("Formulário inválido"));
                    }

                    const updatedData = {
                        name: document.getElementById('userNameModal').value,
                        sector: document.getElementById('userSectorModal').value,
                        isManager: document.getElementById('userIsManagerModal').checked,
                        isAdmin: document.getElementById('userIsAdminModal').checked,
                        email: userToEdit.email 
                    };
                    await updateItemInFirestore('users_profile', userToEdit.id, updatedData, false, getCollectionRef('users_profile', false));
                    if (currentUser.uid === userToEdit.id) {
                        userProfile = { ...userProfile, ...updatedData };
                        updateHeaderUI(); 
                    }
                };
                openModal(`Editar Usuário: ${userToEdit.name}`, formHtml, asyncUserUpdate, 'Salvar Alterações');
            };

            document.getElementById('btn-back-admin-dash-users').addEventListener('click', () => { currentView = 'adminDashboard'; renderApp(); });
            document.querySelectorAll('.btn-edit-user').forEach(btn => btn.addEventListener('click', (e) => {
                const userId = e.currentTarget.dataset.id;
                const user = users.find(u => u.id === userId);
                if(user) openUserModal(user);
            }));
        }

        document.addEventListener('DOMContentLoaded', () => {
            performInitialSignIn(); 
        });

    </script>
</body>
</html>
