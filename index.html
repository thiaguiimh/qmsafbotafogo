import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, // Apenas para setup inicial se necessário, não para UI de admin inicialmente
    signOut, 
    onAuthStateChanged,
    signInWithCustomToken,
    signInAnonymously
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc, 
    addDoc, 
    collection, 
    query, 
    where, 
    getDocs, 
    Timestamp,
    deleteDoc,
    updateDoc,
    onSnapshot,
    orderBy
} from 'firebase/firestore';
import { 
    LogIn, LogOut, PlusCircle, History, Users, CalendarDays, ClipboardList, 
    Building, UserPlus, Trash2, Edit3, Eye, ShieldCheck, UserCog, ListChecks, CheckSquare, XSquare, Loader2, AlertTriangle, Search
} from 'lucide-react';

// Configuração do Firebase (substituída por __firebase_config em produção)
const firebaseConfigProvided = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyDkRi6GWPiVawTe607frndhUbfB77yfVOw", // Exemplo, use a sua
    authDomain: "qmsafbotafogo.firebaseapp.com",
    databaseURL: "https://qmsafbotafogo-default-rtdb.firebaseio.com",
    projectId: "qmsafbotafogo",
    storageBucket: "qmsafbotafogo.firebasestorage.app",
    messagingSenderId: "447753167474",
    appId: "1:447753167474:web:7706e7a5c78b4127a058eb"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfigProvided);
const auth = getAuth(app);
const db = getFirestore(app);
// setLogLevel('debug'); // Para debug do Firestore

const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfigProvided.projectId;

// Componente de Spinner de Carregamento
const LoadingSpinner = ({ message = "Carregando..." }) => (
    <div className="flex flex-col items-center justify-center h-full p-8 text-white">
        <Loader2 className="animate-spin h-12 w-12 text-gray-300 mb-4" />
        <p className="text-lg">{message}</p>
    </div>
);

// Componente Modal Genérico
const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-semibold text-white">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors">
                        <XSquare size={28} />
                    </button>
                </div>
                <div className="text-gray-300">{children}</div>
            </div>
        </div>
    );
};

// Componente de Notificação
const Notification = ({ message, type, onDismiss }) => {
    if (!message) return null;
    const bgColor = type === 'error' ? 'bg-red-700' : type === 'success' ? 'bg-green-700' : 'bg-blue-700';
    return (
        <div className={`fixed top-5 right-5 ${bgColor} text-white p-4 rounded-lg shadow-lg z-[100] flex items-center animate-fadeIn`}>
            {type === 'error' && <AlertTriangle size={20} className="mr-2" />}
            {type === 'success' && <CheckSquare size={20} className="mr-2" />}
            <span>{message}</span>
            <button onClick={onDismiss} className="ml-4 text-xl font-bold hover:text-gray-200">&times;</button>
        </div>
    );
};


function App() {
    const [user, setUser] = useState(null);
    const [userProfile, setUserProfile] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [currentView, setCurrentView] = useState('login'); // login, managerDashboard, adminDashboard, etc.
    const [notification, setNotification] = useState({ message: '', type: '' });

    const [events, setEvents] = useState([]);
    const [categories, setCategories] = useState([]);
    const [sectors, setSectors] = useState([]);
    const [employees, setEmployees] = useState([]);
    const [records, setRecords] = useState([]);
    const [allUsers, setAllUsers] = useState([]); // Para admin gerenciar usuários

    const [isAuthReady, setIsAuthReady] = useState(false);

    // Funções de Coleção Firestore
    const getCollectionRef = (collectionName, isPublic = true) => {
        if (isPublic) {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        }
        return collection(db, 'artifacts', appId, collectionName); // Para 'records' e 'users_profile'
    };
    
    const usersProfileCollection = collection(db, 'artifacts', appId, 'users_profile');


    const showNotification = (message, type = 'info', duration = 3000) => {
        setNotification({ message, type });
        setTimeout(() => {
            setNotification({ message: '', type: '' });
        }, duration);
    };
    
    // Efeito para autenticação e carregamento de perfil
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                setUser(firebaseUser);
                try {
                    const userDocRef = doc(usersProfileCollection, firebaseUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const profileData = userDocSnap.data();
                        setUserProfile(profileData);
                        if (profileData.isAdmin) {
                            setCurrentView('adminDashboard');
                        } else if (profileData.isManager) {
                            setCurrentView('managerDashboard');
                        } else {
                            showNotification("Usuário não possui perfil de gestor ou admin.", "error");
                            setCurrentView('login'); // Ou uma view de 'acesso negado'
                        }
                    } else {
                        showNotification("Perfil do usuário não encontrado.", "error");
                        // Para setup inicial, pode-se criar um perfil aqui se necessário
                        // Ex: await setDoc(userDocRef, { email: firebaseUser.email, name: firebaseUser.displayName || 'Novo Usuário', isAdmin: false, isManager: false, sector: 'N/A', uid: firebaseUser.uid });
                        // setUserProfile({isAdmin: false, isManager: false}); // Reset profile
                        setCurrentView('login');
                        await signOut(auth); // Desloga se não tem perfil
                    }
                } catch (error) {
                    console.error("Erro ao buscar perfil do usuário:", error);
                    showNotification("Erro ao carregar perfil. Tente novamente.", "error");
                    setCurrentView('login');
                }
            } else {
                setUser(null);
                setUserProfile(null);
                setCurrentView('login');
            }
            setIsLoading(false);
            setIsAuthReady(true); // Auth check complete
        });
        return () => unsubscribe();
    }, []);


    // Função para carregar dados (eventos, categorias, etc.)
    const loadData = useCallback(async (collectionName, setter, isPublic = true, queryConstraints = []) => {
        if (!isAuthReady || !userProfile) return; // Só carrega se autenticado e perfil carregado

        const collRef = getCollectionRef(collectionName, isPublic);
        let q = query(collRef, ...queryConstraints);
        
        // Para 'records', gestores só veem os do seu setor
        if (collectionName === 'records' && userProfile && userProfile.isManager && !userProfile.isAdmin) {
            q = query(collRef, where("sector", "==", userProfile.sector));
        }
        // Adicionar orderBy para consistência se necessário, mas pode exigir índices
        // q = query(q, orderBy("createdAt", "desc"));


        const unsubscribe = onSnapshot(q, (snapshot) => {
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Ordenação em memória se orderBy do Firestore não for usado ou for complexo
            if (collectionName === 'records' || collectionName === 'events') {
                 items.sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
            }
            setter(items);
        }, (error) => {
            console.error(`Erro ao carregar ${collectionName}:`, error);
            showNotification(`Falha ao carregar ${collectionName}.`, "error");
        });
        return unsubscribe; // Retorna a função de unsubscribe para limpeza
    }, [isAuthReady, userProfile]);


    // Efeitos para carregar dados dinamicamente
    useEffect(() => {
        if (userProfile) { // Apenas carrega dados se o perfil do usuário estiver carregado
            const unsubscribers = [];
            unsubscribers.push(loadData('events', setEvents));
            unsubscribers.push(loadData('categories', setCategories));
            unsubscribers.push(loadData('sectors', setSectors));
            unsubscribers.push(loadData('employees', setEmployees));
            unsubscribers.push(loadData('records', setRecords, false)); // 'records' não é 'public/data'

            if (userProfile.isAdmin) {
                // Carregar todos os usuários para gerenciamento
                const usersUnsubscribe = onSnapshot(usersProfileCollection, (snapshot) => {
                    const usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllUsers(usersList);
                }, (error) => {
                    console.error("Erro ao carregar usuários:", error);
                    showNotification("Falha ao carregar lista de usuários.", "error");
                });
                unsubscribers.push(usersUnsubscribe);
            }
            return () => unsubscribers.forEach(unsub => unsub && unsub());
        }
    }, [userProfile, loadData]); // Depende de userProfile e da função loadData


    const handleLogin = async (email, password) => {
        setIsLoading(true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged irá lidar com a navegação e carregamento do perfil
            showNotification("Login bem-sucedido!", "success");
        } catch (error) {
            console.error("Erro no login:", error);
            showNotification(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential'
                ? "Email ou senha inválidos."
                : "Erro ao fazer login. Tente novamente.", "error");
            setIsLoading(false);
        }
    };

    const handleLogout = async () => {
        setIsLoading(true);
        try {
            await signOut(auth);
            setUser(null);
            setUserProfile(null);
            setCurrentView('login');
            setEvents([]); setCategories([]); setSectors([]); setEmployees([]); setRecords([]); setAllUsers([]); // Limpa os dados
            showNotification("Logout realizado com sucesso!", "success");
        } catch (error) {
            console.error("Erro no logout:", error);
            showNotification("Erro ao fazer logout.", "error");
        }
        setIsLoading(false);
    };

    // Funções CRUD (Exemplos)
    const addRecord = async (recordData) => {
        if (!userProfile || !userProfile.isManager) {
            showNotification("Apenas gestores podem adicionar registros.", "error");
            return;
        }
        try {
            const recordsCollectionRef = getCollectionRef('records', false);
            await addDoc(recordsCollectionRef, {
                ...recordData,
                managerId: user.uid,
                managerName: userProfile.name,
                sector: userProfile.sector, // Garante que o setor do gestor seja gravado
                createdAt: Timestamp.now()
            });
            showNotification("Registro adicionado com sucesso!", "success");
            setCurrentView(userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard'); // Volta pro dashboard
        } catch (error) {
            console.error("Erro ao adicionar registro:", error);
            showNotification("Falha ao adicionar registro.", "error");
        }
    };
    
    // Funções CRUD para Admin
    const addItem = async (collectionName, data) => {
        if (!userProfile?.isAdmin) return showNotification("Acesso negado.", "error");
        try {
            await addDoc(getCollectionRef(collectionName), { ...data, createdAt: Timestamp.now(), createdBy: user.uid });
            showNotification(`${collectionName.slice(0,-1)} adicionado com sucesso!`, "success");
        } catch (e) { showNotification(`Erro ao adicionar ${collectionName.slice(0,-1)}.`, "error"); console.error(e); }
    };

    const updateItem = async (collectionName, id, data, isPublic = true, targetCollectionRef = null) => {
        if (!userProfile?.isAdmin) return showNotification("Acesso negado.", "error");
        try {
            const itemDocRef = doc(targetCollectionRef || getCollectionRef(collectionName, isPublic), id);
            await updateDoc(itemDocRef, { ...data, updatedAt: Timestamp.now() });
            showNotification(`${collectionName.slice(0,-1)} atualizado com sucesso!`, "success");
        } catch (e) { showNotification(`Erro ao atualizar ${collectionName.slice(0,-1)}.`, "error"); console.error(e); }
    };
    
    const deleteItem = async (collectionName, id, isPublic = true, targetCollectionRef = null) => {
        if (!userProfile?.isAdmin) return showNotification("Acesso negado.", "error");
        // Adicionar confirmação customizada aqui
        setConfirmModal({
            isOpen: true,
            title: `Confirmar Exclusão`,
            message: `Tem certeza que deseja excluir este item de ${collectionName}? Esta ação não pode ser desfeita.`,
            onConfirm: async () => {
                try {
                    await deleteDoc(doc(targetCollectionRef || getCollectionRef(collectionName, isPublic), id));
                    showNotification(`${collectionName.slice(0,-1)} excluído com sucesso!`, "success");
                } catch (e) { showNotification(`Erro ao excluir ${collectionName.slice(0,-1)}.`, "error"); console.error(e); }
                setConfirmModal({ isOpen: false }); 
            },
            onCancel: () => setConfirmModal({ isOpen: false })
        });
    };


    // Estado para modal de confirmação
    const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });


    if (isLoading && !isAuthReady) { // Mostra loading inicial apenas antes do auth estar pronto
        return <div className="bg-gray-900 min-h-screen flex items-center justify-center"><LoadingSpinner message="Inicializando aplicação..." /></div>;
    }


    // Renderização condicional das Views
    const renderView = () => {
        // Se estiver carregando dados do usuário após login, mas auth já está pronto
        if (isAuthReady && user && !userProfile && isLoading) {
             return <div className="bg-gray-900 min-h-screen flex items-center justify-center"><LoadingSpinner message="Carregando perfil do usuário..." /></div>;
        }


        switch (currentView) {
            case 'login':
                return <LoginPage onLogin={handleLogin} isLoading={isLoading} />;
            case 'managerDashboard':
                return <ManagerDashboard setCurrentView={setCurrentView} userProfile={userProfile} />;
            case 'newRecord':
                return <NewRecordForm
                            onAddRecord={addRecord}
                            events={events}
                            categories={categories}
                            employees={employees}
                            userProfile={userProfile}
                            setCurrentView={setCurrentView}
                        />;
            case 'history':
                return <RecordHistory records={records.filter(r => userProfile.isAdmin || r.sector === userProfile.sector)} userProfile={userProfile} setCurrentView={setCurrentView} events={events} categories={categories} employees={employees} />;
            case 'adminDashboard':
                return <AdminDashboard setCurrentView={setCurrentView} userProfile={userProfile} />;
            case 'adminManageEvents':
                return <AdminManageGeneric
                            collectionName="eventos"
                            items={events}
                            fields={[{ name: 'name', label: 'Nome do Evento', type: 'text' }, { name: 'date', label: 'Data', type: 'date' }]}
                            onAdd={(data) => addItem('events', data)}
                            onUpdate={(id, data) => updateItem('events', id, data)}
                            onDelete={(id) => deleteItem('events', id)}
                            setCurrentView={setCurrentView}
                            userProfile={userProfile}
                        />;
            case 'adminManageCategories':
                 return <AdminManageGeneric
                            collectionName="categorias"
                            items={categories}
                            fields={[{ name: 'name', label: 'Nome da Categoria (A, B, C, D)', type: 'text' }, { name: 'description', label: 'Descrição', type: 'text' }]}
                            onAdd={(data) => addItem('categories', data)}
                            onUpdate={(id, data) => updateItem('categories', id, data)}
                            onDelete={(id) => deleteItem('categories', id)}
                            setCurrentView={setCurrentView}
                            userProfile={userProfile}
                        />;
            case 'adminManageSectors':
                return <AdminManageGeneric
                            collectionName="setores"
                            items={sectors}
                            fields={[{ name: 'name', label: 'Nome do Setor', type: 'text' }]}
                            onAdd={(data) => addItem('sectors', data)}
                            onUpdate={(id, data) => updateItem('sectors', id, data)}
                            onDelete={(id) => deleteItem('sectors', id)}
                            setCurrentView={setCurrentView}
                            userProfile={userProfile}
                        />;
            case 'adminManageEmployees':
                 return <AdminManageGeneric
                            collectionName="funcionários"
                            items={employees}
                            fields={[
                                { name: 'name', label: 'Nome do Funcionário', type: 'text' },
                                { name: 'registration', label: 'Matrícula', type: 'text' },
                                { name: 'sector', label: 'Setor', type: 'select', options: sectors.map(s => ({ value: s.name, label: s.name })) }
                            ]}
                            onAdd={(data) => addItem('employees', data)}
                            onUpdate={(id, data) => updateItem('employees', id, data)}
                            onDelete={(id) => deleteItem('employees', id)}
                            setCurrentView={setCurrentView}
                            userProfile={userProfile}
                        />;
            case 'adminManageUsers':
                return <AdminManageUsers
                            users={allUsers}
                            sectors={sectors}
                            onUpdateUser={async (id, data) => {
                                await updateItem('users_profile', id, data, false, usersProfileCollection);
                                // Atualiza o perfil do usuário logado se ele mesmo for editado
                                if (user.uid === id) {
                                    setUserProfile(prev => ({ ...prev, ...data }));
                                }
                            }}
                            setCurrentView={setCurrentView}
                            userProfile={userProfile}
                        />;
            default:
                return <LoginPage onLogin={handleLogin} isLoading={isLoading} />;
        }
    };

    const commonButtonClass = "w-full flex items-center justify-center text-lg bg-gray-700 hover:bg-yellow-500 hover:text-gray-900 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:-translate-y-1";
    const botafogoGradient = "bg-gradient-to-r from-black via-gray-800 to-black";

    return (
        <div className={`min-h-screen ${botafogoGradient} text-gray-100 font_inter`}>
            <Notification message={notification.message} type={notification.type} onDismiss={() => setNotification({ message: '', type: '' })} />
            <Modal isOpen={confirmModal.isOpen} onClose={confirmModal.onCancel} title={confirmModal.title}>
                <p className="mb-6">{confirmModal.message}</p>
                <div className="flex justify-end space-x-3">
                    <button onClick={confirmModal.onCancel} className="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-white transition-colors">Cancelar</button>
                    <button onClick={confirmModal.onConfirm} className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-md text-white transition-colors">Confirmar</button>
                </div>
            </Modal>

            {userProfile && (
                <header className="bg-black bg-opacity-80 shadow-2xl p-4">
                    <div className="container mx-auto flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                            {/* Logo pode ser um SVG ou imagem */}
                            <img src="https://placehold.co/50x50/FFFFFF/000000?text=BFR" alt="Logo Botafogo" className="h-10 w-10 rounded-full border-2 border-yellow-400" />
                            <h1 className="text-2xl md:text-3xl font-bold text-white tracking-wider">
                                Portal <span className="text-yellow-400">Quadro Móvel</span>
                            </h1>
                        </div>
                        <div className="flex items-center space-x-4">
                            <span className="text-sm md:text-base text-gray-300 hidden sm:block">
                                Olá, <span className="font-semibold text-yellow-400">{userProfile.name}</span> ({userProfile.isAdmin ? 'Admin' : userProfile.isManager ? `Gestor - ${userProfile.sector}` : 'Usuário'})
                            </span>
                            <button
                                onClick={handleLogout}
                                className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-md hover:shadow-lg flex items-center space-x-2"
                            >
                                <LogOut size={20} />
                                <span className="hidden md:inline">Sair</span>
                            </button>
                        </div>
                    </div>
                </header>
            )}
            <main className="container mx-auto p-4 md:p-8">
                {renderView()}
            </main>
            {userProfile && (
                 <footer className="text-center p-6 mt-10 border-t border-gray-700 text-gray-500 text-sm">
                    © {new Date().getFullYear()} SAF Botafogo - Sistema de Quadro Móvel. Todos os direitos reservados. User ID: {user?.uid}
                </footer>
            )}
        </div>
    );
}


// --- PÁGINA DE LOGIN ---
const LoginPage = ({ onLogin, isLoading }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!email || !password) {
            // Idealmente, usar o sistema de notificação do App.js
            alert("Por favor, preencha email e senha."); 
            return;
        }
        onLogin(email, password);
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-gray-900 to-gray-800 p-4">
            <div className="w-full max-w-md bg-gray-800 bg-opacity-80 backdrop-blur-md shadow-2xl rounded-xl p-8 border border-gray-700">
                <div className="flex flex-col items-center mb-8">
                    <img src="https://placehold.co/100x100/FFFFFF/000000?text=BFR" alt="Logo Botafogo" className="h-24 w-24 rounded-full border-4 border-yellow-400 mb-4" />
                    <h2 className="text-4xl font-extrabold text-white text-center">Portal <span className="text-yellow-400">Quadro Móvel</span></h2>
                    <p className="text-gray-400 mt-2 text-center">Acesso exclusivo para gestores e administradores.</p>
                </div>
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                            className="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-all"
                            placeholder="seu.email@safbfr.com.br"
                        />
                    </div>
                    <div>
                        <label htmlFor="password" className="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                        <input
                            id="password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                            className="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-all"
                            placeholder="••••••••"
                        />
                    </div>
                    <button
                        type="submit"
                        disabled={isLoading}
                        className="w-full flex items-center justify-center text-lg bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-500 text-black font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50"
                    >
                        {isLoading ? <Loader2 className="animate-spin h-5 w-5 mr-2" /> : <LogIn size={20} className="mr-2" />}
                        {isLoading ? 'Entrando...' : 'Entrar'}
                    </button>
                </form>
            </div>
             <footer className="text-center p-6 mt-10 text-gray-500 text-sm">
                © {new Date().getFullYear()} SAF Botafogo. Todos os direitos reservados.
            </footer>
        </div>
    );
};

// --- DASHBOARD DO GESTOR ---
const ManagerDashboard = ({ setCurrentView, userProfile }) => {
    const commonButtonClass = "w-full md:w-auto flex-grow md:flex-grow-0 flex items-center justify-center text-lg bg-gray-700 hover:bg-yellow-500 hover:text-gray-900 text-white font-semibold py-4 px-8 rounded-lg transition-all duration-300 ease-in-out shadow-xl hover:shadow-2xl transform hover:-translate-y-1 border-2 border-transparent hover:border-yellow-300";
    return (
        <div className="animate-fadeIn">
            <h2 className="text-3xl font-bold text-white mb-2">Bem-vindo, Gestor <span className="text-yellow-400">{userProfile.name}</span>!</h2>
            <p className="text-gray-400 mb-8 text-lg">Setor: <span className="font-semibold">{userProfile.sector}</span>. Utilize as opções abaixo para gerenciar os quadros móveis.</p>
            <div className="flex flex-col md:flex-row justify-center items-center space-y-6 md:space-y-0 md:space-x-8 mt-12">
                <button onClick={() => setCurrentView('newRecord')} className={commonButtonClass}>
                    <PlusCircle size={28} className="mr-3" /> Incluir Novo Registro
                </button>
                <button onClick={() => setCurrentView('history')} className={commonButtonClass}>
                    <History size={28} className="mr-3" /> Histórico de Registros
                </button>
            </div>
        </div>
    );
};

// --- FORMULÁRIO DE NOVO REGISTRO ---
const NewRecordForm = ({ onAddRecord, events, categories, employees, userProfile, setCurrentView }) => {
    const [selectedEvent, setSelectedEvent] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('');
    const [selectedEmployee, setSelectedEmployee] = useState('');
    const [notes, setNotes] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    // Filtra funcionários elegíveis (pode ser expandido com mais lógica, ex: por setor)
    const eligibleEmployees = employees; // Por enquanto, todos os funcionários cadastrados

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!selectedEvent || !selectedCategory || !selectedEmployee) {
            alert("Todos os campos (Evento, Categoria, Funcionário) são obrigatórios."); // Usar notificação do App
            return;
        }
        setIsLoading(true);
        await onAddRecord({
            eventId: selectedEvent,
            eventName: events.find(ev => ev.id === selectedEvent)?.name,
            categoryId: selectedCategory,
            categoryName: categories.find(cat => cat.id === selectedCategory)?.name,
            employeeId: selectedEmployee,
            employeeName: employees.find(emp => emp.id === selectedEmployee)?.name,
            notes: notes,
            // sector é adicionado automaticamente na função onAddRecord com base no userProfile
        });
        setIsLoading(false);
        // A navegação de volta é feita dentro de onAddRecord no App.js
    };
    
    const inputClass = "w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-colors";
    const labelClass = "block text-sm font-medium text-gray-300 mb-1";

    return (
        <div className="max-w-2xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 animate-fadeIn">
            <h2 className="text-3xl font-bold text-white mb-8 text-center">Incluir Novo Registro de Quadro Móvel</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label htmlFor="event" className={labelClass}>Evento:</label>
                    <select id="event" value={selectedEvent} onChange={(e) => setSelectedEvent(e.target.value)} className={inputClass} required>
                        <option value="">Selecione o Evento</option>
                        {events.sort((a,b) => new Date(b.date) - new Date(a.date)).map(event => (
                            <option key={event.id} value={event.id}>{event.name} ({new Date(event.date + 'T00:00:00').toLocaleDateString()})</option>
                        ))}
                    </select>
                </div>
                <div>
                    <label htmlFor="category" className={labelClass}>Classificação (Quadro Móvel):</label>
                    <select id="category" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className={inputClass} required>
                        <option value="">Selecione a Classificação</option>
                        {categories.map(category => (
                            <option key={category.id} value={category.id}>{category.name} - {category.description}</option>
                        ))}
                    </select>
                </div>
                <div>
                    <label htmlFor="employee" className={labelClass}>Funcionário:</label>
                    <select id="employee" value={selectedEmployee} onChange={(e) => setSelectedEmployee(e.target.value)} className={inputClass} required>
                        <option value="">Selecione o Funcionário</option>
                        {eligibleEmployees.map(employee => (
                            <option key={employee.id} value={employee.id}>{employee.name} ({employee.registration}) - {employee.sector}</option>
                        ))}
                    </select>
                </div>
                <div>
                    <label htmlFor="notes" className={labelClass}>Observações (Opcional):</label>
                    <textarea id="notes" value={notes} onChange={(e) => setNotes(e.target.value)} className={`${inputClass} h-24`} placeholder="Detalhes adicionais..."></textarea>
                </div>
                <div className="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
                    <button type="button" onClick={() => setCurrentView(userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard')}
                        className="w-full sm:w-auto px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors duration-300">
                        Cancelar
                    </button>
                    <button type="submit" disabled={isLoading}
                        className="w-full sm:w-auto px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg transition-colors duration-300 disabled:bg-gray-400 flex items-center justify-center">
                        {isLoading ? <Loader2 className="animate-spin h-5 w-5 mr-2" /> : <PlusCircle size={20} className="mr-2" />}
                        {isLoading ? 'Salvando...' : 'Salvar Registro'}
                    </button>
                </div>
            </form>
        </div>
    );
};

// --- HISTÓRICO DE REGISTROS ---
const RecordHistory = ({ records, userProfile, setCurrentView, events, categories, employees }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterSector, setFilterSector] = useState(userProfile.isAdmin ? '' : userProfile.sector); // Admin pode filtrar, gestor vê só o seu
    
    const getEventName = (id) => events.find(e => e.id === id)?.name || 'N/A';
    const getCategoryName = (id) => categories.find(c => c.id === id)?.name || 'N/A';
    const getEmployeeName = (id) => employees.find(e => e.id === id)?.name || 'N/A';

    const filteredRecords = records
        .filter(record => {
            const searchLower = searchTerm.toLowerCase();
            return (
                (getEventName(record.eventId).toLowerCase().includes(searchLower) ||
                 getCategoryName(record.categoryId).toLowerCase().includes(searchLower) ||
                 getEmployeeName(record.employeeId).toLowerCase().includes(searchLower) ||
                 record.managerName.toLowerCase().includes(searchLower) ||
                 record.sector.toLowerCase().includes(searchLower) ||
                 (record.createdAt?.toDate?.().toLocaleDateString() || '').includes(searchLower)
                ) &&
                (userProfile.isAdmin ? (filterSector ? record.sector === filterSector : true) : record.sector === userProfile.sector)
            );
        })
        .sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));


    if (!records) return <LoadingSpinner message="Carregando histórico..." />;

    return (
        <div className="animate-fadeIn">
            <div className="flex flex-col md:flex-row justify-between items-center mb-8">
                <h2 className="text-3xl font-bold text-white mb-4 md:mb-0">Histórico de Registros {userProfile.isAdmin && filterSector ? `(${filterSector})` : userProfile.isManager ? `(${userProfile.sector})` : ''}</h2>
                <button onClick={() => setCurrentView(userProfile.isAdmin ? 'adminDashboard' : 'managerDashboard')}
                    className="px-6 py-3 bg-gray-700 hover:bg-yellow-500 hover:text-gray-900 text-white font-semibold rounded-lg transition-all duration-300">
                    Voltar ao Dashboard
                </button>
            </div>

            <div className="mb-6 p-4 bg-gray-800 rounded-lg shadow">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="relative">
                        <input 
                            type="text"
                            placeholder="Buscar em todos os campos..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full p-3 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500"
                        />
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20}/>
                    </div>
                    {userProfile.isAdmin && (
                        <select 
                            value={filterSector} 
                            onChange={(e) => setFilterSector(e.target.value)}
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500"
                        >
                            <option value="">Todos os Setores</option>
                            {/* Supondo que 'sectors' está disponível no escopo do App e passado como prop ou carregado aqui */}
                            {/* Exemplo: sectors.map(s => <option key={s.id} value={s.name}>{s.name}</option>) */}
                            {/* Por ora, vamos usar os setores dos próprios records para popular */}
                            {[...new Set(records.map(r => r.sector))].sort().map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                    )}
                </div>
            </div>

            {filteredRecords.length === 0 ? (
                <p className="text-gray-400 text-center text-xl py-10">Nenhum registro encontrado {searchTerm || filterSector ? 'para os filtros aplicados' : (userProfile.isManager ? 'para o seu setor' : '')}.</p>
            ) : (
                <div className="overflow-x-auto bg-gray-800 shadow-2xl rounded-lg border border-gray-700">
                    <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-750">
                            <tr>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Data</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Evento</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Categoria</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Funcionário</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Setor</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Gestor Lançador</th>
                                <th className="px-6 py-4 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Obs.</th>
                            </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                            {filteredRecords.map(record => (
                                <tr key={record.id} className="hover:bg-gray-700 transition-colors">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{record.createdAt?.toDate?.().toLocaleString() || 'N/A'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{getEventName(record.eventId)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{getCategoryName(record.categoryId)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{getEmployeeName(record.employeeId)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{record.sector}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{record.managerName}</td>
                                    <td className="px-6 py-4 text-sm text-gray-300 max-w-xs truncate" title={record.notes}>{record.notes || '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// --- DASHBOARD DO ADMIN ---
const AdminDashboard = ({ setCurrentView, userProfile }) => {
    const adminButtonClass = "flex flex-col items-center justify-center p-6 bg-gray-700 hover:bg-yellow-500 hover:text-gray-900 text-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border-2 border-transparent hover:border-yellow-300";
    const iconSize = 40;

    return (
        <div className="animate-fadeIn">
            <h2 className="text-4xl font-bold text-white mb-2">Painel Administrativo</h2>
            <p className="text-gray-400 mb-10 text-lg">Bem-vindo, <span className="font-semibold text-yellow-400">{userProfile.name}</span>. Gerencie todos os aspectos do sistema.</p>
            
            <div className="mb-12">
                <h3 className="text-2xl font-semibold text-yellow-400 mb-6 border-b-2 border-gray-700 pb-2">Ações de Gestor</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <button onClick={() => setCurrentView('newRecord')} className={`${adminButtonClass} bg-blue-600 hover:bg-blue-500`}>
                        <PlusCircle size={iconSize} className="mb-3 text-white" />
                        <span className="text-lg font-semibold">Incluir Novo Registro</span>
                    </button>
                    <button onClick={() => setCurrentView('history')} className={`${adminButtonClass} bg-indigo-600 hover:bg-indigo-500`}>
                        <History size={iconSize} className="mb-3 text-white" />
                        <span className="text-lg font-semibold">Ver Histórico Completo</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 className="text-2xl font-semibold text-yellow-400 mb-6 border-b-2 border-gray-700 pb-2">Gerenciamento do Sistema</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button onClick={() => setCurrentView('adminManageEvents')} className={adminButtonClass}>
                        <CalendarDays size={iconSize} className="mb-3" /> <span className="text-lg font-semibold">Gerenciar Eventos</span>
                    </button>
                    <button onClick={() => setCurrentView('adminManageCategories')} className={adminButtonClass}>
                        <ListChecks size={iconSize} className="mb-3" /> <span className="text-lg font-semibold">Gerenciar Categorias</span>
                    </button>
                    <button onClick={() => setCurrentView('adminManageSectors')} className={adminButtonClass}>
                        <Building size={iconSize} className="mb-3" /> <span className="text-lg font-semibold">Gerenciar Setores</span>
                    </button>
                    <button onClick={() => setCurrentView('adminManageEmployees')} className={adminButtonClass}>
                        <Users size={iconSize} className="mb-3" /> <span className="text-lg font-semibold">Gerenciar Funcionários</span>
                    </button>
                    <button onClick={() => setCurrentView('adminManageUsers')} className={adminButtonClass}>
                        <UserCog size={iconSize} className="mb-3" /> <span className="text-lg font-semibold">Gerenciar Usuários</span>
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- COMPONENTE GENÉRICO DE GERENCIAMENTO (ADMIN) ---
const AdminManageGeneric = ({ collectionName, items, fields, onAdd, onUpdate, onDelete, setCurrentView, userProfile }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [currentItem, setCurrentItem] = useState(null); // Para edição
    const [formData, setFormData] = useState({});
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        // Inicializa formData com base nos fields
        const initialForm = {};
        fields.forEach(field => initialForm[field.name] = '');
        setFormData(initialForm);
    }, [fields]);

    const handleOpenModal = (item = null) => {
        setCurrentItem(item);
        if (item) {
            // Preenche o formulário com os dados do item para edição
            const itemData = {};
            fields.forEach(field => itemData[field.name] = item[field.name] || '');
            setFormData(itemData);
        } else {
            // Limpa o formulário para adição
            const initialForm = {};
            fields.forEach(field => initialForm[field.name] = '');
            setFormData(initialForm);
        }
        setIsModalOpen(true);
    };

    const handleCloseModal = () => {
        setIsModalOpen(false);
        setCurrentItem(null);
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        if (currentItem) { // Edição
            await onUpdate(currentItem.id, formData);
        } else { // Adição
            await onAdd(formData);
        }
        setIsLoading(false);
        handleCloseModal();
    };

    const handleDelete = async (id) => {
        setIsLoading(true);
        await onDelete(id); // A confirmação já está no onDelete principal
        setIsLoading(false);
    };
    
    const inputClass = "w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-colors";
    const labelClass = "block text-sm font-medium text-gray-300 mb-1";

    return (
        <div className="animate-fadeIn">
            <div className="flex justify-between items-center mb-8">
                <h2 className="text-3xl font-bold text-white">Gerenciar {collectionName.charAt(0).toUpperCase() + collectionName.slice(1)}</h2>
                <div className="space-x-3">
                    <button onClick={() => handleOpenModal()} className="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg transition-colors duration-300 flex items-center">
                        <PlusCircle size={20} className="mr-2" /> Adicionar Novo
                    </button>
                     <button onClick={() => setCurrentView('adminDashboard')} className="px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors duration-300">
                        Voltar
                    </button>
                </div>
            </div>

            {items.length === 0 ? (
                 <p className="text-gray-400 text-center text-xl py-10">Nenhum item em "{collectionName}" cadastrado.</p>
            ) : (
                <div className="overflow-x-auto bg-gray-800 shadow-2xl rounded-lg border border-gray-700">
                    <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-750">
                            <tr>
                                {fields.map(field => (
                                    <th key={field.name} className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">{field.label}</th>
                                ))}
                                <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Criado Em</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                            {items.map(item => (
                                <tr key={item.id} className="hover:bg-gray-700 transition-colors">
                                    {fields.map(field => (
                                        <td key={`${item.id}-${field.name}`} className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                            {field.type === 'date' && item[field.name] ? new Date(item[field.name] + 'T00:00:00').toLocaleDateString() : item[field.name] || '-'}
                                        </td>
                                    ))}
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{item.createdAt?.toDate?.().toLocaleDateString() || '-'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                        <button onClick={() => handleOpenModal(item)} className="text-blue-400 hover:text-blue-300 transition-colors"><Edit3 size={20} /></button>
                                        <button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-400 transition-colors"><Trash2 size={20} /></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}

            <Modal isOpen={isModalOpen} onClose={handleCloseModal} title={currentItem ? `Editar ${collectionName.slice(0,-1)}` : `Adicionar Novo ${collectionName.slice(0,-1)}`}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    {fields.map(field => (
                        <div key={field.name}>
                            <label htmlFor={field.name} className={labelClass}>{field.label}:</label>
                            {field.type === 'select' ? (
                                <select name={field.name} id={field.name} value={formData[field.name] || ''} onChange={handleChange} className={inputClass} required>
                                    <option value="">Selecione</option>
                                    {field.options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                </select>
                            ) : (
                                <input type={field.type || 'text'} name={field.name} id={field.name} value={formData[field.name] || ''} onChange={handleChange} className={inputClass} required />
                            )}
                        </div>
                    ))}
                    <div className="flex justify-end space-x-3 pt-4">
                         <button type="button" onClick={handleCloseModal} className="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-white transition-colors">Cancelar</button>
                        <button type="submit" disabled={isLoading} className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-md transition-colors disabled:bg-gray-400 flex items-center justify-center">
                             {isLoading ? <Loader2 className="animate-spin h-5 w-5 mr-2" /> : (currentItem ? <Edit3 size={18} className="mr-2"/> : <PlusCircle size={18} className="mr-2"/>)}
                             {isLoading ? 'Salvando...' : (currentItem ? 'Salvar Alterações' : 'Adicionar')}
                        </button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};

// --- GERENCIAR USUÁRIOS (ADMIN) ---
const AdminManageUsers = ({ users, sectors, onUpdateUser, setCurrentView, userProfile }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [currentUserData, setCurrentUserData] = useState(null); // Para edição
    const [formData, setFormData] = useState({ email: '', name: '', sector: '', isAdmin: false, isManager: false });
    const [isLoading, setIsLoading] = useState(false);

    const handleOpenModal = (user = null) => {
        setCurrentUserData(user);
        if (user) {
            setFormData({
                email: user.email || '',
                name: user.name || '',
                sector: user.sector || '',
                isAdmin: user.isAdmin || false,
                isManager: user.isManager || false,
            });
        } else {
            // Para adicionar novo usuário (não implementado neste exemplo, pois requer createUserWithEmailAndPassword e criação de perfil)
            // Por ora, o modal é apenas para edição.
            setFormData({ email: '', name: '', sector: '', isAdmin: false, isManager: false });
        }
        setIsModalOpen(true);
    };
    
    const handleCloseModal = () => {
        setIsModalOpen(false);
        setCurrentUserData(null);
    };

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!currentUserData) return; // Só edição por enquanto
        setIsLoading(true);
        await onUpdateUser(currentUserData.id, {
            ...formData,
            // uid e email não devem ser alterados aqui, apenas roles e sector
            email: currentUserData.email, // Mantém o email original
        });
        setIsLoading(false);
        handleCloseModal();
    };

    const inputClass = "w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-colors";
    const labelClass = "block text-sm font-medium text-gray-300 mb-1";
    const checkboxLabelClass = "flex items-center space-x-2 text-gray-300";
    const checkboxClass = "h-5 w-5 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-400";


    return (
        <div className="animate-fadeIn">
            <div className="flex justify-between items-center mb-8">
                <h2 className="text-3xl font-bold text-white">Gerenciar Usuários</h2>
                 <button onClick={() => setCurrentView('adminDashboard')} className="px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors duration-300">
                    Voltar
                </button>
                {/* Botão de adicionar novo usuário pode ser implementado aqui, mas requer fluxo de criação de conta no Auth */}
            </div>
            <div className="overflow-x-auto bg-gray-800 shadow-2xl rounded-lg border border-gray-700">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-750">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Nome</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Email</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Setor</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Gestor?</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Admin?</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody className="bg-gray-800 divide-y divide-gray-700">
                        {users.map(user => (
                            <tr key={user.id} className="hover:bg-gray-700 transition-colors">
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{user.name}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{user.email}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{user.sector || 'N/A'}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{user.isManager ? <CheckSquare className="text-green-400"/> : <XSquare className="text-red-400"/>}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{user.isAdmin ? <ShieldCheck className="text-yellow-400"/> : <XSquare className="text-red-400"/>}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onClick={() => handleOpenModal(user)} className="text-blue-400 hover:text-blue-300 transition-colors"><Edit3 size={20} /></button>
                                    {/* Excluir usuário é complexo (Auth + Firestore), omitido por simplicidade inicial */}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            <Modal isOpen={isModalOpen} onClose={handleCloseModal} title={`Editar Usuário: ${currentUserData?.name}`}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="name" className={labelClass}>Nome:</label>
                        <input type="text" name="name" id="name" value={formData.name} onChange={handleChange} className={inputClass} required />
                    </div>
                    <div>
                        <label htmlFor="email" className={labelClass}>Email: (Não editável)</label>
                        <input type="email" name="email" id="email" value={formData.email} className={`${inputClass} bg-gray-600 cursor-not-allowed`} readOnly />
                    </div>
                    <div>
                        <label htmlFor="sector" className={labelClass}>Setor:</label>
                        <select name="sector" id="sector" value={formData.sector} onChange={handleChange} className={inputClass} required>
                            <option value="">Selecione o Setor</option>
                            {sectors.map(sector => (
                                <option key={sector.id} value={sector.name}>{sector.name}</option>
                            ))}
                        </select>
                    </div>
                    <div className="grid grid-cols-2 gap-4 pt-2">
                        <label className={checkboxLabelClass}>
                            <input type="checkbox" name="isManager" checked={formData.isManager} onChange={handleChange} className={checkboxClass} />
                            <span>É Gestor?</span>
                        </label>
                        <label className={checkboxLabelClass}>
                            <input type="checkbox" name="isAdmin" checked={formData.isAdmin} onChange={handleChange} className={checkboxClass} />
                            <span>É Admin?</span>
                        </label>
                    </div>
                    <div className="flex justify-end space-x-3 pt-4">
                        <button type="button" onClick={handleCloseModal} className="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-white transition-colors">Cancelar</button>
                        <button type="submit" disabled={isLoading} className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-md transition-colors disabled:bg-gray-400 flex items-center justify-center">
                            {isLoading ? <Loader2 className="animate-spin h-5 w-5 mr-2" /> : <Edit3 size={18} className="mr-2"/>}
                            {isLoading ? 'Salvando...' : 'Salvar Alterações'}
                        </button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};


export default App;
